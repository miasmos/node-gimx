"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),_get=function(e,t,i){for(var n=!0;n;){var s=e,r=t,a=i;l=h=o=void 0,n=!1,null===s&&(s=Function.prototype);var l=Object.getOwnPropertyDescriptor(s,r);if(void 0!==l){if("value"in l)return l.value;var o=l.get;return void 0===o?void 0:o.call(a)}var h=Object.getPrototypeOf(s);if(null===h)return void 0;e=h,t=r,i=a,n=!0}},messenger=require("./messenger"),exec=require("child_process").exec,gimx=function(e){function t(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this),this.debug=e.debug||!1,this.remote_port=e.port||this.log("No port specified.",2),this.remote_host=e.host||this.log("No host specified.",2),this.path='"'+e.path+'gimx.exe"'||"gimx",this.macros={},this.timeline={},this.timelineIntervals=[],this.tempChain=[],this._hasChained=!1,this.globalTime=0,this.currentTimelineIndex=0,this.intervalTime=10,this.globalCallback,this.repeat=!1,this.log("Init")}return _inherits(t,e),_createClass(t,[{key:"press",value:function(e,t){return this._hasChained?this.tempChain.push(["press",e,t]):this._normalizedSend([{button:e,mod:t}]),this}},{key:"hold",value:function(e,t){return this._hasChained?this.tempChain.push(["hold",e]):this._normalizedSend([{button:e,mod:t}]),this}},{key:"release",value:function(e){return this._hasChained?this.tempChain.push(["release",e]):this._normalizedSend([{button:e,mod:0}]),this}},{key:"wait",value:function(e){return this._hasChained&&this.tempChain.push(["wait",e]),this}},{key:"macro",value:function(e){return this.tempChain.push(["macro",e]),this._hasChained=!0,this}},{key:"add",value:function(){if(this._hasChained=!1,!("macro"!==this.tempChain[0][0]||this.tempChain.length<=1)){var e=this.tempChain[0][1];this.tempChain.splice(0,1);for(var t in this.tempChain){var i=this.tempChain[t][0],n=this.tempChain[t][1];this.tempChain[t][2];"press"!=i&&"release"!=i&&"hold"!=i||this._isValidButton(n)||this.log("Invalid button '"+n+"' found in macro "+e+"."+i+"()",2)}this.macros[e]=this.tempChain,this.tempChain=[]}}},{key:"run",value:function(){function e(t){for(var s in t){var r=t[s][0],a=t[s][1],h=t[s][2];if("macro"==r&&(a in i.macros||i.log("Invalid macro "+a+" found in macro "+n,2),e(i.macros[a])),"wait"!=r){if("macro"!=r){if("release"==r&&"press"==o&&a!=l||"release"!==r&&"press"==o){var u={action:"release",value1:l,value2:h},c=i.timelineIntervals[i.timelineIntervals.length-1]+10;c in i.timeline?i.timeline[c].push(u):(i.timeline[c]=[u],i.timelineIntervals.push(c))}var m={action:r,value1:a,value2:h};l=a,o=r,i.globalTime in i.timeline?i.timeline[i.globalTime].push(m):(i.timeline[i.globalTime]=[m],i.timelineIntervals.push(i.globalTime))}}else i.globalTime+=a}}var t=arguments.length<=0||void 0===arguments[0]?!1:arguments[0],i=this;if(this._hasChained=!1,!("macro"!==this.tempChain[0][0]||this.tempChain.length<1)){var n=this.tempChain[0][1];this.repeat=t,console.log(this.macros);for(var s in this.tempChain){var r=this.tempChain[s][0],a=this.tempChain[s][1];this.tempChain[s][2];"press"!=r&&"release"!=r&&"hold"!=r||this._isValidButton(a)||this.log("Invalid button '"+a+"' found in macro "+n+"."+r+"()",2)}e(this.tempChain);var l=void 0,o=void 0,h=this.timeline[this.timelineIntervals[this.timelineIntervals.length-1]];if(h=h[h.length-1],"press"==h.action){var u={action:"release",value1:h.value1,value2:void 0};i.globalTime+=10,i.timeline[i.globalTime]=[u],i.timelineIntervals.push(i.globalTime)}console.log(this.timeline),console.log(this.timelineIntervals),this.globalTotalTime=this.globalTime,this.globalTime=0,this.globalCallback=setInterval(function(){i._tick()},this.intervalTime)}}},{key:"_normalizedSend",value:function(e){for(var t in e){var i=e[t].mod,n=e[t].button;if("undefined"==typeof i&&(i=1),0>i&&i>1)return void this.log("Normalized send requires a mod between 0 and 1, ignoring",1);"lstick x"==n||"lstick y"==n||"rstick x"==n||"rstick y"==n?(i*=255,i-=128):"acc x"==n||"acc y"==n||"acc z"==n||"gyro"==n?(i*=511,i-=256):"select"==n||"start"==n||"PS"==n||"l3"==n||"r3"==n?i=1>i?0:255:("up"==n||"right"==n||"down"==n||"left"==n||"triangle"==n||"circle"==n||"cross"==n||"square"==n||"l1"==n||"r1"==n||"l2"==n||"r2"==n)&&(i*=255),e[t].mod=i}this._send(e)}},{key:"_send",value:function(e){var t="";for(var i in e){var n=e[i].button,s=e[i].mod,r=void 0,a=void 0,l=!0;if("lstick x"==n||"lstick y"==n||"rstick x"==n||"rstick y"==n)r=-128,a=127;else if("acc x"==n||"acc y"==n||"acc z"==n||"gyro"==n)r=-512,a=511;else if("select"==n||"start"==n||"PS"==n||"l3"==n||"r3"==n)r=0,a=255,l=!1;else{if("up"!=n&&"right"!=n&&"down"!=n&&"left"!=n&&"triangle"!=n&&"circle"!=n&&"cross"!=n&&"square"!=n&&"l1"!=n&&"r1"!=n&&"l2"!=n&&"r2"!=n)return void this.log("Button "+n+" not recognized, ignoring",1);r=0,a=255}if(l){if(!(s>=r&&a>=s))return void this.log(n+" has a range of "+r+" to "+a+", given "+s+", ignoring",1)}else if(s!=r&&s!=a)return void this.log(n+" must be either "+r+" or "+a+", given "+s+", ignoring",1);t+='--event "'+n+"("+s+')" '}this.debug?this.log(this.globalTime+": "+this.path+" "+t+"-d "+this.remote_host+":"+this.remote_port):this._exec(this.path+" "+t+"-d "+this.remote_host+":"+this.remote_port)}},{key:"_isValidButton",value:function(e){var t=["lstick x","lstick y","rstick x","rstick y","acc x","acc y","acc z","gyro","select","start","PS","l3","r3","up","right","down","left","triangle","circle","cross","square","l1","r1","l2","r2"];return t.indexOf(e)>-1}},{key:"_tick",value:function(){if(this.globalTime>=this.timelineIntervals[this.currentTimelineIndex]){var e=this.timelineIntervals[this.currentTimelineIndex].toString(),t=[];for(var i in this.timeline[e])t.push({button:this.timeline[e][i].value1,mod:"release"==this.timeline[e][i].action?0:this.timeline[e][i].value2});this._normalizedSend(t),this.currentTimelineIndex++}if(this.globalTime>=this.globalTotalTime){if(this.repeat)return this.globalTime=0,this.currentTimelineIndex=0,this.log("repeating"),void this.emit("repeat");clearInterval(this.globalCallback),this.log("done")}this.globalTime+=this.intervalTime}},{key:"_hasMultipleButtons",value:function(e){var t=arguments.length<=1||void 0===arguments[1]?!0:arguments[1],i=void 0,n=[];if(e.indexOf(",")>-1)i=e.split(",");else{if(!(e.indexOf(" ")>-1))return!1;i=e.split(" ")}for(var s in i)n.push({button:i[s],mod:t?1:0})}},{key:"_exec",value:function(e){var t=this;exec(e,function(i,n,s){(i||s)&&(t.emit("sendfailure"),t.log(i||s,2)),t.emit("sendsuccess"),t.log(t.globalTime+": "+e)})}},{key:"log",value:function(e,t){switch(t){case 1:t="WARNING";break;case 2:t="ERROR";break;default:t=!1}if("ERROR"==t)throw"gimx-node: "+e;console.log(t?"gimx-node: "+t+" "+e:"gimx-node: "+e)}}]),t}(messenger);module.exports=gimx;