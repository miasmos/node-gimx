"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,i,s){return i&&e(t.prototype,i),s&&e(t,s),t}}(),_get=function(e,t,i){for(var s=!0;s;){var n=e,r=t,a=i;l=h=o=void 0,s=!1,null===n&&(n=Function.prototype);var l=Object.getOwnPropertyDescriptor(n,r);if(void 0!==l){if("value"in l)return l.value;var o=l.get;return void 0===o?void 0:o.call(a)}var h=Object.getPrototypeOf(n);if(null===h)return void 0;e=h,t=r,i=a,s=!0}},messenger=require("./messenger"),exec=require("child_process").exec,gimx=function(e){function t(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this),this.debug=e.debug||!1,this.remote_port=e.port||this.log("No port specified.",2),this.remote_host=e.host||this.log("No host specified.",2),this.path='"'+e.path+'gimx.exe"'||"gimx",this.macros={},this.timeline={},this.timelineIntervals=[],this.tempChain=[],this._hasChained=!1,this.globalTime=0,this.currentTimelineIndex=0,this.intervalTime=10,this.globalCallback,this.repeat=!1,this.log("Init")}return _inherits(t,e),_createClass(t,[{key:"press",value:function(e,t){return this._hasChained?this.tempChain.push(["press",e,t]):this.normalizedSend(e,t),this}},{key:"release",value:function(e){return this._hasChained?this.tempChain.push(["release",e]):this.normalizedSend(e,0),this}},{key:"wait",value:function(e){return this._hasChained&&this.tempChain.push(["wait",e]),this}},{key:"macro",value:function(e){return this.tempChain.push(["macro",e]),this._hasChained=!0,this}},{key:"add",value:function(){if(this._hasChained=!1,!("macro"!==this.tempChain[0][0]||this.tempChain.length<=1)){var e=this.tempChain[0][1];this.tempChain.splice(0,1);for(var t in this.tempChain){var i=this.tempChain[t][0],s=this.tempChain[t][1];this.tempChain[t][2];"press"!=i&&"release"!=i||this._isValidButton(s)||this.log("Invalid button '"+s+"' found in macro "+e+"."+i+"()",2)}this.macros[e]=this.tempChain,this.tempChain=[],console.log(this.macros)}}},{key:"run",value:function(){function e(t){for(var n in t){var r=t[n][0],a=t[n][1],l=t[n][2];if("macro"==r&&(a in i.macros||i.log("Invalid macro "+a+" found in macro "+s,2),e(i.macros[a])),"wait"!=r){if("macro"!=r){var o={action:r,value1:a,value2:l};i.globalTime in i.timeline?i.timeline[i.globalTime].push(o):(i.timeline[i.globalTime]=[o],i.timelineIntervals.push(i.globalTime))}}else i.globalTime+=a}}var t=arguments.length<=0||void 0===arguments[0]?!1:arguments[0],i=this;if(this._hasChained=!1,!("macro"!==this.tempChain[0][0]||this.tempChain.length<1)){var s=this.tempChain[0][1];this.repeat=t;for(var n in this.tempChain){var r=this.tempChain[n][0],a=this.tempChain[n][1];this.tempChain[n][2];"press"!=r&&"release"!=r||this._isValidButton(a)||this.log("Invalid button '"+a+"' found in macro "+s+"."+r+"()",2)}e(this.tempChain),console.log(this.timeline),console.log(this.timelineIntervals),this.globalTotalTime=this.globalTime,this.globalTime=0,this.globalCallback=setInterval(function(){i._tick()},this.intervalTime)}}},{key:"normalizedSend",value:function(e,t){return"undefined"==typeof t&&(t=1),0>t&&t>1?void this.log("Normalized send requires a mod between 0 and 1, ignoring",1):("lstick x"==e||"lstick y"==e||"rstick x"==e||"rstick y"==e?(t*=255,t-=128):"acc x"==e||"acc y"==e||"acc z"==e||"gyro"==e?(t*=511,t-=256):"select"==e||"start"==e||"PS"==e||"l3"==e||"r3"==e?t=1>t?0:255:("up"==e||"right"==e||"down"==e||"left"==e||"triangle"==e||"circle"==e||"cross"==e||"square"==e||"l1"==e||"r1"==e||"l2"==e||"r2"==e)&&(t*=255),void this.send(e,t))}},{key:"send",value:function(e,t){var i,s,n=!0;if("lstick x"==e||"lstick y"==e||"rstick x"==e||"rstick y"==e)i=-128,s=127;else if("acc x"==e||"acc y"==e||"acc z"==e||"gyro"==e)i=-512,s=511;else if("select"==e||"start"==e||"PS"==e||"l3"==e||"r3"==e)i=0,s=255,n=!1;else{if("up"!=e&&"right"!=e&&"down"!=e&&"left"!=e&&"triangle"!=e&&"circle"!=e&&"cross"!=e&&"square"!=e&&"l1"!=e&&"r1"!=e&&"l2"!=e&&"r2"!=e)return void this.log("Button "+e+" not recognized, ignoring",1);i=0,s=255}if(n){if(!(t>=i&&s>=t))return void this.log(e+" has a range of "+i+" to "+s+", given "+t+", ignoring",1)}else if(t!=i&&t!=s)return void this.log(e+"must be either "+i+" or "+s+", given "+t+", ignoring",1);this.lastPressed=e,this.debug?this.log(this.globalTime+": sent "+e+"("+t+")"):this._exec(this.path+' --event "'+e+"("+t+')" -d '+this.remote_host+":"+this.remote_port,e,t)}},{key:"_isValidButton",value:function(e){var t=["lstick x","lstick y","rstick x","rstick y","acc x","acc y","acc z","gyro","select","start","PS","l3","r3","up","right","down","left","triangle","circle","cross","square","l1","r1","l2","r2"];return t.indexOf(e)>-1}},{key:"_tick",value:function(){if(this.globalTime>=this.timelineIntervals[this.currentTimelineIndex]){var e=this.timelineIntervals[this.currentTimelineIndex].toString();for(var t in this.timeline[e]){var i=this.timeline[e][t].action,s=this.timeline[e][t].value1,n=this.timeline[e][t].value2;switch(i){case"press":this.press(s,n);break;case"release":this.release(s)}}this.currentTimelineIndex++}if(this.globalTime>=this.globalTotalTime){if(this.repeat)return this.globalTime=0,this.currentTimelineIndex=0,this.log("repeating"),void this.emit("repeat");clearInterval(this.globalCallback),this.log("done")}this.globalTime+=this.intervalTime}},{key:"_exec",value:function(e,t,i){var s=this;exec(e,function(e,n,r){(e||r)&&(s.emit("sendfailure"),s.log(e||r,2)),s.log("Sent "+t+"("+i+") successfully."),s.emit("sendsuccess")})}},{key:"log",value:function(e,t){switch(t){case 1:t="WARNING";break;case 2:t="ERROR";break;default:t=!1}if("ERROR"==t)throw"gimx-node: "+e;console.log(t?"gimx-node: "+t+" "+e:"gimx-node: "+e)}}]),t}(messenger);module.exports=gimx;